<!doctype html>
<html>
  <head>
    <title>Socket.IO Snake Multiplayer</title>
    <style>
      * { margin: 0; padding: 0; }
      body { font: 24px Helvetica, Arial; }
      #scores { float: right; padding-top: 16px; padding-right: 16px; }
    </style>
    <meta name="viewport" content="user-scalable=no, width=device-width, initial-scale=1, maximum-scale=1">
  </head>
  <body style="overflow:hidden">

    <script src="/socket.io/socket.io.js"></script>
    <script src="https://code.jquery.com/jquery-1.11.1.js"></script>
    <script src="http://hammerjs.github.io/dist/hammer-time.min.js"></script>
    <script src="http://hammerjs.github.io/dist/hammer.min.js"></script>
    <script>
      "use strict";
    
      

      let Board = {
        "scores":[
          {"total":3936,"tiles":251,"i":7,"dead":false},
          {"total":1165,"tiles":131,"i":2,"dead":false},
          {"total":0,"tiles":0,"i":5,"dead":true},
          {"total":0,"tiles":0,"i":1,"dead":true},
          {"total":0,"tiles":0,"i":3,"dead":true},
          {"total":0,"tiles":0,"i":4,"dead":true},
          {"total":0,"tiles":0,"i":0,"dead":true},
          {"total":0,"tiles":0,"i":6,"dead":true}],
        "turn":715,
        "attackIndex":525,
        // first width, height. Then number of soldiers. Then terrain type. positive is which player owns it. negative is:
        // -1: empty
        // -2: mountain in sight
        // -3: empty fow
        // -4: obstacle fow
        "map":[23,22,0,10,10,10,10,10,11,0,0,0,0,10,10,11,10,11,11,0,0,0,0,13,0,10,10,57,9,9,71,4,10,0,11,11,9,9,0,10,8,13,0,0,0,12,13,
            0,10,10,3,0,9,0,4,0,8,8,8,8,8,8,8,8,8,8,8,10,12,0,0,10,10,3,11,9,11,4,4,8,0,11,10,10,10,10,10,0,12,8,8,8,8,527,10,10,3,0,9,0,
            4,7,0,13,12,10,7,7,1,2,0,13,13,10,12,13,0,10,10,3,11,9,9,4,4,0,0,13,1,3,1,567,0,12,11,12,10,12,12,0,0,10,3,10,9,0,0,7,7,1,1,
            1,1,5,5,5,5,2,28,30,12,12,18,10,10,3,10,9,9,0,0,4,9,9,4,7,13,0,11,5,11,2,0,0,12,18,0,0,3,0,9,0,0,0,4,11,13,0,7,13,11,11,5,0,2,0,
            0,0,12,11,0,3,53,4,4,4,4,4,11,15,0,7,13,11,11,71,9,2,2,41,12,12,10,10,67,10,10,10,10,4,0,48,0,0,7,0,0,11,46,71,0,2,2,2,0,10,10,0,
            10,0,0,0,40,5,0,0,0,7,0,0,0,0,0,0,2,2,2,0,0,10,8,0,0,0,0,3,3,3,8,8,7,8,0,0,0,0,5,5,2,2,2,10,0,2,2,0,0,0,0,3,3,3,3,2,11,0,0,0,0,0,
            2,2,2,0,10,0,2,2,0,0,0,4,3,3,0,0,2,6,11,0,0,0,0,0,2,28,0,10,10,3,2,0,0,0,4,3,125,0,9,117,6,6,0,0,0,0,1,0,1,0,10,10,0,2,0,0,0,0,9,
            3,4,0,0,10,0,0,0,0,0,0,0,0,0,10,10,49,2,0,0,4,7,7,3,4,10,0,0,0,0,0,0,0,0,0,0,0,0,5,4,6,5,2,2,8,8,3,230,9,6,0,0,0,0,0,0,0,0,0,0,0,
            5,10,6,10,0,10,10,0,0,2,0,0,0,0,0,0,0,0,0,0,0,0,10,89,6,6,11,48,10,10,0,0,2,0,0,0,0,0,0,0,0,0,0,0,0,11,11,11,50,0,0,10,10,10,10,2,
            0,0,0,0,0,0,0,0,0,0,0,0,-2,7,7,7,7,7,7,-2,-1,-1,-2,7,7,7,7,7,7,-1,-3,-1,-2,7,-2,7,7,7,7,7,7,7,7,-1,7,7,7,7,-2,7,7,7,-2,-1,-2,7,7,-2,
            7,7,7,-2,7,-2,7,-2,7,7,7,7,7,7,7,7,7,7,7,7,7,-2,-2,7,7,7,7,7,7,7,7,7,-2,7,7,7,7,7,7,-2,7,7,7,7,7,7,7,7,7,-2,7,-2,7,7,-2,7,7,7,7,7,7,7,
            -2,7,7,7,7,7,-2,7,7,7,7,7,7,7,7,-1,-2,7,7,7,7,7,-1,7,7,7,7,7,7,-2,-2,7,7,7,7,-2,-2,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,-1,-2,
            7,7,7,7,7,7,-2,2,7,7,7,-2,-2,7,7,-2,-2,7,-2,7,-2,-1,-2,7,7,7,-2,7,7,2,2,7,-1,7,-1,-1,-2,7,7,-2,7,7,7,7,7,7,7,7,7,-1,7,7,2,2,7,2,7,7,
            -1,7,7,7,7,7,7,7,7,7,7,-2,-1,-2,-2,7,-2,-2,2,2,2,-2,7,7,7,-1,7,7,-2,7,-2,-1,-1,7,7,-2,-2,-1,7,-2,-3,-3,-3,-3,-2,7,7,7,-2,-2,7,7,-2,
            -1,-3,-1,7,7,7,2,2,7,2,-3,-3,-4,-3,2,2,7,2,2,7,-2,2,2,-4,-3,-1,-2,7,7,7,7,7,2,-2,-3,-3,-3,-3,2,7,2,-3,7,-2,2,2,-4,-4,-4,2,7,7,-2,-2,
            7,7,2,-4,-4,-3,-3,-2,7,2,-3,7,7,7,2,-4,-4,-3,2,7,7,-2,2,7,2,2,-3,-3,-3,-3,2,-2,2,-3,7,7,-1,2,-4,-3,-3,-2,7,7,2,-2,-2,2,-3,-3,-3,-4,-4,
            -3,-3,-3,-3,7,7,-1,2,-3,-3,2,2,2,7,2,7,-2,-3,-3,-3,-4,-3,-3,-3,-3,-3,-3,-2,7,7,2,2,2,2,7,7,7,7,2,2,-3,-3,-3,-3,-3,-3,-3,-3,-3,-4,-2,7,
            7,7,7,-2,7,7,-2,-1,2,-2,-3,-3,-4,-4,-3,-3,-4,-3,-3,-3,-3,7,7,7,7,7,-1,7,7,-1,-2,2,-3,-3,-3,-3,-3,-3,-4,-3,-3,-3,-4,-3,7,7,7,-1,-1,-2,
            7,7,7,7,2,-3,-3,-3,-3,-3,-3,-3,-3,-3,-3,-3,-3],
        "cities":[393,146,424,107,357,465,25,247,227,486,157,260,156,145,172,239,223,28,127,354,461,210],
        "generals":[-1,-1,-1,-1,-1,-1,-1,91]
      
      }
      
      let View = {
        offsetX: 0,
        offsetY: 0,
        squareSize: 100
      }  
      
      let images = {
        city: "data:image/png;base64,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",
        obstacle: "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAABkCAMAAABHPGVmAAAAqFBMVEUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAs30iGAAAAN3RSTlMABwP89fnt8duUEgsjGg4W6OGddGks1c/Hs4x/Wb6sXzQfp1RKQTm5ons9MMvERijlmFCHhG1jxilZsAAAA7RJREFUaN7s1tlyomAQhuFmEQTjbtyNCWqMSzKaSea9/zubGQTbJalCkaPwnFgWFA39f3+D5HK5XC6X+6F8U7LXb0nmynatIlnzYCAZeyqAW5VsNQA8OVW9Zd07C6BwJ4dmDy64wUpuJCAUiDK27Fg3Wqt7C2wbeJS9F/Z+yy30gI8+MJLYGLC94TAAmEl6j4Dr+w7wpknADVdjamntNObAQqQJdMy4sONOJdQHy5e0loBTETHqwFgipiE7K+BZ0hoBzXgd6qWzeGsXr/cGbMJLm5243KEh8EtS6gKfEpoCzkn/K3XYSErvQN3Qzp3simU7TEXEkOt0gD+HYbafdJO+OgBtIz48l6sMgaIpsQegcbRJoRhXNdq8yxXMNjA8iFIBrHuJrIHCtqLvHIrXNGwMtE1RHtDTIow0BzN0eS5hFOG4BVUXmGmRl6OYgV2WS7WAtRwZAF1Nd+N0LAdykWiQTOVIqQZMJLSAiUY9spTLNIHX86fT9V2u9m2sAT1PZ2gCetOzLwPX0v+abafqO3osoQUwlzMTYPcRVt72S5rC/61r6eBJpuJ8M8S7RB9hQfQrZYdd0Mw14ElyH0DvuxeMWz1M1xzY+PLPM2CtJCnfBb4+vRfd7iCaBp9oCgMNSwJ94G87dreTMBCEYXj6h42lQgzVCNhABIIiKQRj7//OzJDar5bdmcZsz/qewgFQduZpc5teKoRtr3wpwsZvlIb4iwvhzUFhByVOnc/XKE7wd8H+tIchtZc+QblrzIDg4+8oWnQUNlhqqIGwQ8Qqa625cNxV2GeyBoR5z3zKvTah8o7CDtdkDQjj7xRl1KyIABhN2HOyBoTtAoNg5tjJmrAnZAsIS2Ke/H57VpwgHHu5bHUg7NF8kb+v47KLsEluw28qb6Yujs5ZF/aiE19Nc7oeYSsS2lXCVlqV3CglU3uMMEXY+pWDlxDAsZSFPU1ICggrM+EgTR8UYSsBYZKmLoqwtYAw4QeJCkXYekCYdbW9CML2SA8Iky7ZRha2HhBm7oIXBWErAWHmkpP5LHixuKFtCBOG6F0qClsPCLN0xD2TIGwlIMzcIYAFBGGLAWHSFv/0dWEjEWHmJiNeoDfCfv3PU71pRuII04WtM/CUyQt0rgpbbyaxZluPMAh7Ra7LsT0hbNeNmbSbprAzct8XRhiE7bqET/h7LeygoD5almxeCNt1kMm+Ena0JtdhKPBDhHWMCeS+34cI98cwJffhduaJh0vyRv01K+OU+s7PUxoaGhpy3Q8pPbS5r8LmKAAAAABJRU5ErkJggg==",
        mountain: "data:image/png;base64,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",
        general: "data:image/png;base64,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",
      }
      
      for (let name in images) if (images.hasOwnProperty(name)) {
        let i = new Image()
        i.src = images[name];
        i.onload = () => { console.log(`${name} loaded`) }
        images[name] = i;
      }
      
      let players = [
        {color: "red"},
        {color: "darkgreen"},
        {color: "gold"},
        {color: "maroon"},
        {color: "navy"},
        {color: "purple"},
        {color: "teal"},
        {color: "lightgreen"}
      ]

      function square(map, x, y) {
        let width = map[0],
            height = map[1]
        
        return {
          soldiers: map[2 + y*width + x],
          terrain: map[2 + y*width + x + width*height]
        }

      }
      
   
      

      function drawBoard(
          {map, cities, generals}, 
          {offsetX, offsetY, squareSize}, 
          canvas) 
      {
        let ctx = canvas.getContext("2d")
        ctx.font = "20px Georgia"
        ctx.textAlign = "center"
        ctx.textBaseline = 'middle'
        ctx.strokeStyle="black";        
        ctx.fillText("HEJ", 10, 10)
        ctx.strokeRect(10, 10, 100, 100)

        let width = canvas.width
        let height = canvas.height
        let ox = Math.floor(offsetX / squareSize)
        let oy = Math.floor(offsetY / squareSize)

        
        for (let y=oy; y * squareSize - offsetY < height; y++)
          for (let x=ox; x * squareSize - offsetX < width; x++)
            drawSquare(ctx, square(map, x, y), x * squareSize - offsetX, y * squareSize - offsetY, squareSize)
      }

      function drawSquare(ctx, {soldiers, terrain}, x, y, size) {
        
        if (terrain >= 0) {
          ctx.fillStyle = players[terrain].color;
          ctx.fillRect(x, y, size, size)
          ctx.strokeRect(x, y, size, size)
          ctx.fillStyle = "black";
          ctx.fillText(soldiers, x + size/2, y + size/2);
          console.log("drawing player rect", players[terrain].color, x, y, size)
        } else {
          ctx.fillStyle = ["white", "white", "darkgray", "darkgray"][1-terrain]
          
          let image = [null, images.mountain, null, images.obstacle][1-terrain];

          ctx.fillRect(x, y, size, size)
          ctx.strokeRect(x, y, size, size)
          console.log("drawing terrain rect", ["white", "white", "darkgray", "darkgray"][1-terrain], x, y, size)
  
          if (image != null) {
            ctx.drawImage(image, x, y, size, size)
          }
        }
      }
      
    
      var socket = io();
      var playerId;
      var nickname;

      // Authenticate
      $('#auth').click(() => {
        nickname = $('#nickname').val().trim();
        if(nickname && nickname !== '') {
          socket.emit('auth', { nickname }, (session) => {
            playerId = session.id;
            console.log('new session: ' + playerId);
          });
        }
      });

      // Create & insert canvas
      var canvas = document.createElement("canvas")
      canvas.width = window.innerWidth;
      canvas.height= window.innerHeight;
      
      
      
      let down = null
      let moved = false
      canvas.onmousedown = e => {
        moved = false
        down = Object.assign({x:e.clientX,y:e.clientY}, View)
        console.log(e, down)
      }
      canvas.onmouseup = e => {
        down = null
        if (!moved)
          console.log(e, "CLACK!")
      }
      canvas.onclick = e => {
        console.log(e, "CLICK!")
      }
      canvas.onmousemove = e => {
        if (down) {
          moved = true
          View.offsetX = Math.max(0, down.offsetX - e.clientX + down.x)
          View.offsetY = Math.max(0, down.offsetY - e.clientY + down.y)
          
          console.log(down.offsetX - e.clientX + down.x,down.offsetY - e.clientY + down.y )
          
          drawBoard(Board, View, canvas)
        }
      }
      console.log(canvas.width, document.body.clientWidth, canvas.height, document.body.clientHeight)
      
      document.body.appendChild(canvas)

      var mc = new Hammer.Manager(canvas);
      
      mc.add( new Hammer.Pan({ direction: Hammer.DIRECTION_ALL, threshold: 0 }) );
      mc.add( new Hammer.Tap({ event: 'doubletap', taps: 2 }) );
      mc.add( new Hammer.Tap({ event: 'tap', taps: 1 }) );
      
      mc.on("pan", e => {
        socket.emit("msg", {pan: e});
      });
      mc.on("tap", (e) => {
        sopcket.emit("msg", {tap: e}) 
      });
      

      // Create game with canvas
      //var game = new GameCanvas(canvas);
      // Send keystrokes
      document.onkeydown = (ev) => {
          socket.emit('key', ev.keyCode)

      }
      
      setInterval( () => drawBoard(Board, View, canvas), 100)

      // Receive state from server
      socket.on('state', (stuff) => {
        // and redraw the game
        //game.draw(stuff.players, stuff.apples);
      })

    </script>
  </body>
</html>

